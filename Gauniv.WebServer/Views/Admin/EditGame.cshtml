@model Gauniv.WebServer.Data.Game

@{
    ViewData["Title"] = "Modifier le jeu";
    var categories = ViewBag.Categories as List<Gauniv.WebServer.Data.Category>;
    var selectedCategories = ViewBag.SelectedCategories as List<int>;
}

<style>
    .game-image-card { display:flex; flex-direction:column; width:100%; }
    .game-image-card .card-img-top { height:10rem; object-fit:cover; width:100%; flex-shrink:0; }
    .game-image-card .card-body { display:flex; flex-direction:column; justify-content:space-between; min-height:140px; }
    .game-image-card .d-grid .btn { width:100%; white-space:normal; }
    .col-6.col-sm-4.col-md-3.col-lg-2.d-flex { align-items:stretch; }

    .back-action { display:flex; gap:12px; }
    @@media (max-width: 576px) { .back-action { flex-direction:column; } }
</style>

<div class="container mt-4">

@if (TempData["EditGameSuccess"] != null)
{
    <div class="alert alert-success">@TempData["EditGameSuccess"]</div>
}
@if (TempData["EditGameError"] != null)
{
    <div class="alert alert-danger">@TempData["EditGameError"]</div>
}

@{
    var returnUrl = ViewData["ReturnUrl"] as string ?? Url.Action("Games", "Admin");
}

<!-- Header: title left, big back button right -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1 class="h3 mb-0">Modifier le jeu</h1>
    </div>

    <div class="back-action">
        <a class="btn btn-lg btn-primary d-inline-flex align-items-center" href="@returnUrl" role="button" aria-label="Retour à la liste des jeux">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrow-left me-2" viewBox="0 0 16 16" aria-hidden="true">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l3.147 3.146a.5.5 0 0 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
            </svg>
            Retourner à la liste
        </a>
    </div>
</div>

<form asp-action="EditGame" asp-route-id="@Model.Id" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <input type="hidden" name="returnUrl" value="@returnUrl" />
    
    <div class="mb-3">
        <label class="form-label">Nom du jeu</label>
        <input name="Name" class="form-control" value="@Model.Name" />
    </div>

    <div class="mb-3">
        <label class="form-label">Description</label>
        <textarea name="Description" class="form-control" rows="5">@Model.Description</textarea>
    </div>

    <div class="mb-3">
        <label class="form-label">Prix (€)</label>
        <input name="Price" type="number" step="0.01" min="0" class="form-control" value="@Model.Price" />
    </div>

    <div class="mb-3">
        <label class="form-label">Catégories</label>
        <div>
            @if (categories != null && categories.Any())
            {
                foreach (var category in categories)
                {
                    var isChecked = selectedCategories?.Contains(category.Id) ?? false;
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="CategoryIds" value="@category.Id" 
                               id="category_@category.Id" @(isChecked ? "checked" : "")>
                        <label class="form-check-label" for="category_@category.Id">
                            @category.Name
                        </label>
                    </div>
                }
            }
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label">Binaire actuel</label>
        @if (!string.IsNullOrEmpty(Model.PayloadPath))
        {
            <p class="text-success"><i class="bi bi-file-check"></i> Fichier uploadé (@(Math.Round((Model.Size ?? 0L) / (1024.0 * 1024.0), 1).ToString(System.Globalization.CultureInfo.CurrentCulture)) Mo)</p>
        }
        else
        {
            <p class="text-muted">Aucun fichier uploadé</p>
        }
    </div>

    <div class="mb-3">
        <label class="form-label">Remplacer le binaire du jeu (optionnel)</label>
        <input type="file" name="payload" class="form-control" accept=".zip,.rar,.7z,.exe" />
        <small class="form-text text-muted">Laisser vide pour conserver le fichier actuel</small>
    </div>

    <div class="mb-3">
        <label class="form-label">Images</label>

        <div class="row g-3">
            @if (Model.Images.Any())
            {
                @foreach (var img in Model.Images.OrderBy(i => i.SortOrder))
                {
                    <div class="col-6 col-sm-4 col-md-3 col-lg-2 d-flex">
                        <div class="card game-image-card w-100 h-100">
                            <img src="@Url.Action("GetImage", "GamesWeb", new { id = img.Id })" class="card-img-top" alt="Image du jeu" />
                            <div class="card-body">
                                <div>
                                    @if (img.IsPrimary)
                                    {
                                        <span class="badge bg-primary">Principale</span>
                                    }
                                </div>
                                <div class="d-grid gap-2 mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="postAction('@Url.Action("DeleteGameImage","Admin")',{ imageId: '@img.Id', gameId: '@Model.Id' })">Supprimer</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="postAction('@Url.Action("SetPrimaryGameImage","Admin")',{ imageId: '@img.Id', gameId: '@Model.Id' })">Définir principale</button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12 text-muted">Aucune image uploadée pour le moment.</div>
            }
        </div>

        <div class="mt-3">
            <div class="input-group">
                <input type="file" name="imageFile" class="form-control" accept="image/*" />
            </div>
            <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" name="setPrimaryImage" id="setPrimaryImage" />
                <label class="form-check-label" for="setPrimaryImage">Définir comme principale</label>
            </div>
         </div>
     </div>

     <div class="mt-4">
         <button type="submit" class="btn btn-primary">
             <i class="bi bi-save"></i> Enregistrer
         </button>
        <a class="btn btn-secondary" href="@Url.Action("Games", "Admin")">
            <i class="bi bi-x-circle"></i> Annuler
        </a>
     </div>
 </form>
</div> <!-- fin container -->

@section Scripts {
 @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
 <script>
    async function postAction(url, data) {
        try {
            const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
            const token = tokenInput ? tokenInput.value : '';
            const form = new FormData();
            for (const k in data) form.append(k, data[k]);
            if (token) form.append('__RequestVerificationToken', token);

            const res = await fetch(url, { 
                method: 'POST', 
                body: form, 
                credentials: 'same-origin',
                headers: Object.assign({ 'X-Requested-With': 'XMLHttpRequest' }, token ? { 'RequestVerificationToken': token } : {})
             });
 
            try {
                const payload = await res.clone().json();
                if (payload && payload.redirectUrl) {
                    window.location.href = payload.redirectUrl + (payload.redirectUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
                    return;
                }
            } catch (e) {
            }
 
             if (res.redirected) {
                 window.location.href = res.url;
                 return;
             }
 
             window.location.reload();
        } catch (err) {
            console.error(err);
            showInlineAlert('danger', 'Erreur lors de la requête');
         }
     }

    function showInlineAlert(level, message) {
        const container = document.querySelector('.container');
        if (!container) return alert(message);
        const div = document.createElement('div');
        div.className = `alert alert-${level}`;
        div.innerText = message;
        container.insertBefore(div, container.firstChild);
    }
 </script>
}
