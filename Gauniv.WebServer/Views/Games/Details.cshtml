@model Gauniv.WebServer.ViewModels.GameViewModel
@{
    ViewData["Title"] = Model.Name;
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                @{
                    // Use carousel when multiple images available, otherwise show placeholder
                    var hasImages = Model.Images.Any();
                    var carouselId = "gameCarousel-" + Model.Id;
                }

                @if (hasImages)
                {
                    <div id="@carouselId" class="carousel slide bg-dark" data-bs-ride="carousel" style="position:relative; height:360px; overflow:hidden;">
                        <div class="carousel-indicators">
                            @for (int i = 0; i < Model.Images.Count; i++)
                            {
                                var isActive = i == 0;
                                <button type="button" data-bs-target="#@carouselId" data-bs-slide-to="@i" class="@(isActive ? "active" : "")" aria-current="@(isActive ? "true" : "false")" aria-label="Slide @(@i + 1)"
                                        style="width:14px;height:14px;border-radius:50%;margin:0 6px;border:0;outline:none; background-color:@(isActive ? "#fff" : "rgba(255,255,255,0.85)"); box-shadow:0 1px 3px rgba(0,0,0,0.35);">
                                </button>
                            }
                        </div>

                        <div class="carousel-inner" style="height:100%">
                            @for (int i = 0; i < Model.Images.Count; i++)
                            {
                                var img = Model.Images[i];
                                <div class="carousel-item @(i == 0 ? "active" : "")" style="height:100%">
                                    <img src="@Url.Action("GetImage", "GamesWeb", new { id = img.Id })" class="d-block w-100" alt="@Model.Name image @i" style="height:100%; object-fit:cover;" />
                                </div>
                            }
                        </div>

                        <button class="carousel-control-prev" type="button" data-bs-target="#@carouselId" data-bs-slide="prev" style="position:absolute; left:12px; top:50%; transform:translateY(-50%); z-index:5; width:56px;height:56px;border-radius:50%;background-color:rgba(0,0,0,0.55);border:none;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 20px rgba(0,0,0,0.4);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                            <span class="visually-hidden">Précédent</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#@carouselId" data-bs-slide="next" style="position:absolute; right:12px; top:50%; transform:translateY(-50%); z-index:5; width:56px;height:56px;border-radius:50%;background-color:rgba(0,0,0,0.55);border:none;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 20px rgba(0,0,0,0.4);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                            <span class="visually-hidden">Suivant</span>
                        </button>
                    </div>
                }
                else
                {
                    <div class="card-img-top d-flex align-items-center justify-content-center bg-dark" style="height:360px; overflow:hidden;">
                        <h4 class="m-0 text-white d-flex align-items-center justify-content-center" style="height:100%">Image / Banner</h4>
                    </div>
                }
                 
                <div class="card-body">
                    <h2>@Model.Name</h2>
                    <div class="mb-3">
                        @if (Model.Categories.Any())
                        {
                            foreach (var c in Model.Categories)
                            {
                                <span class="badge bg-secondary me-1">@c</span>
                            }
                        }
                    </div>
                    <h3 class="text-primary">@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", Model.Price)</h3>
                    <p class="text-muted">Taille: @(Model.Size > 1024 ? (Model.Size / 1024) + " KB" : Model.Size + " KB")</p>

                    <div class="mt-3">
                        @if (Model.IsOwned)
                        {
                            <span class="badge bg-success">Possédé</span>
                        }
                        else if (User.Identity != null && User.Identity.IsAuthenticated)
                        {
                            // Authenticated user: show purchase button only for regular users (not admins)
                            if (User.IsInRole("User"))
                            {
                                <form asp-controller="GamesWeb" asp-action="Purchase" method="post">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@Model.Id" />
                                    <button class="btn btn-lg btn-primary">Acheter</button>
                                </form>
                            }
                            // If authenticated but not in role User (e.g. Admin), show nothing here
                        }
                        else
                        {
                            // Only show login link for non-authenticated visitors
                            <a class="btn btn-lg btn-primary" asp-area="Identity" asp-page="/Account/Login">Se connecter pour acheter</a>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <h4>Description</h4>
            <p>@Model.Description</p>

            <hr />

            <h5>Informations</h5>
            <ul>
                <li>Prix: @String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", Model.Price)</li>
                <li>Taille: @(Model.Size > 1024 ? (Model.Size / 1024) + " KB" : Model.Size + " KB")</li>
                <li>Catégories: @(string.Join(", ", Model.Categories))</li>
            </ul>

            <hr />
        </div>
    </div>
</div>
